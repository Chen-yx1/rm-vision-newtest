#include <iostream>
#include <chrono>
#include <opencv2/opencv.hpp>

#include "armor_detector/detector.hpp"
#include "armor_detector/params_loader.hpp"

int main(int argc, char** argv) {
    std::cout << "==========================================" << std::endl;
    std::cout << "RoboMaster è§†è§‰è€ƒæ ¸ - è£…ç”²æ¿è¯†åˆ« (2.2.1.1)" << std::endl;
    std::cout << "ç¼–è¯‘æ—¶é—´: " << __DATE__ << " " << __TIME__ << std::endl;
    std::cout << "==========================================" << std::endl;
    
    // æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°
    if (argc < 2) {
        std::cerr << "âŒ ä½¿ç”¨æ–¹æ³•: " << argv[0] << " <è§†é¢‘æ–‡ä»¶è·¯å¾„>" << std::endl;
        std::cerr << "ç¤ºä¾‹: " << argv[0] << " test_video.mp4" << std::endl;
        std::cerr << "ç¤ºä¾‹: " << argv[0] << " 0 (ä½¿ç”¨æ‘„åƒå¤´)" << std::endl;
        return -1;
    }
    
    // æ‰“å¼€è§†é¢‘æ–‡ä»¶
    std::string video_path = argv[1];
    cv::VideoCapture cap;
    
    if (video_path == "0" || video_path == "1") {
        std::cout << "ğŸ“· å°è¯•æ‰“å¼€æ‘„åƒå¤´ " << video_path << std::endl;
        cap.open(std::stoi(video_path));
    } else {
        std::cout << "ğŸ¬ æ‰“å¼€è§†é¢‘æ–‡ä»¶: " << video_path << std::endl;
        cap.open(video_path);
    }
    
    if (!cap.isOpened()) {
        std::cerr << "âŒ æ— æ³•æ‰“å¼€è§†é¢‘æº: " << video_path << std::endl;
        return -1;
    }
    
    // è·å–è§†é¢‘ä¿¡æ¯
    int width = static_cast<int>(cap.get(cv::CAP_PROP_FRAME_WIDTH));
    int height = static_cast<int>(cap.get(cv::CAP_PROP_FRAME_HEIGHT));
    double fps = cap.get(cv::CAP_PROP_FPS);
    int total_frames = static_cast<int>(cap.get(cv::CAP_PROP_FRAME_COUNT));
    
    std::cout << "âœ… è§†é¢‘æºæ‰“å¼€æˆåŠŸ" << std::endl;
    std::cout << "   åˆ†è¾¨ç‡: " << width << "x" << height << std::endl;
    std::cout << "   å¸§ç‡: " << fps << " FPS" << std::endl;
    if (total_frames > 0) {
        std::cout << "   æ€»å¸§æ•°: " << total_frames << std::endl;
    }
    
    // åˆ›å»ºæ£€æµ‹å™¨
    auto params = rm_auto_aim::createDefaultParams();
    rm_auto_aim::Detector detector(params);
    
    std::cout << "\nğŸš€ å¼€å§‹å¤„ç†è§†é¢‘..." << std::endl;
    std::cout << "   æŒ‰ 'q' é”®é€€å‡º" << std::endl;
    std::cout << "   æŒ‰ ' ' ç©ºæ ¼é”®æš‚åœ" << std::endl;
    std::cout << "   æŒ‰ 's' é”®ä¿å­˜å½“å‰å¸§" << std::endl;
    std::cout << "==========================================" << std::endl;
    
    cv::Mat frame;
    int frame_count = 0;
    double total_process_time = 0;
    
    while (true) {
        auto frame_start = std::chrono::high_resolution_clock::now();
        
        // è¯»å–ä¸€å¸§
        if (!cap.read(frame)) {
            if (frame_count == 0) {
                std::cerr << "âŒ æ— æ³•è¯»å–è§†é¢‘å¸§" << std::endl;
                break;
            } else {
                std::cout << "âœ… è§†é¢‘æ’­æ”¾å®Œæˆ" << std::endl;
                break;
            }
        }
        
        frame_count++;
        
        // 1. é¢„å¤„ç†ï¼ˆé¢œè‰²åˆ†å‰²ï¼‰
        auto preprocess_start = std::chrono::high_resolution_clock::now();
        cv::Mat binary = detector.preprocessImage(frame);
        auto preprocess_end = std::chrono::high_resolution_clock::now();
        double preprocess_time = std::chrono::duration<double>(preprocess_end - preprocess_start).count() * 1000;
        
        // 2. æŸ¥æ‰¾ç¯æ¡
        auto find_start = std::chrono::high_resolution_clock::now();
        auto lights = detector.findLights(binary);
        auto find_end = std::chrono::high_resolution_clock::now();
        double find_time = std::chrono::duration<double>(find_end - find_start).count() * 1000;
        
        // 3. åœ¨åŸå§‹å¸§ä¸Šç»˜åˆ¶ç»“æœ
        cv::Mat display_frame = frame.clone();
        
        // ç»˜åˆ¶æ¯ä¸ªæ£€æµ‹åˆ°çš„ç¯æ¡
        for (const auto& light : lights) {
            cv::Point2f vertices[4];
            light.rect.points(vertices);
            
            // ç»˜åˆ¶æ—‹è½¬çŸ©å½¢ï¼ˆç»¿è‰²ï¼‰
            for (int j = 0; j < 4; j++) {
                cv::line(display_frame, vertices[j], vertices[(j + 1) % 4], 
                        cv::Scalar(0, 255, 0), 2);
            }
            
            // ç»˜åˆ¶ä¸­å¿ƒç‚¹ï¼ˆçº¢è‰²ï¼‰
            cv::circle(display_frame, light.center, 3, cv::Scalar(0, 0, 255), -1);
            
            // æ˜¾ç¤ºç¯æ¡ä¿¡æ¯
            std::string info = "L:" + std::to_string(int(light.length)) + 
                              " R:" + std::to_string(light.width/light.length).substr(0,4);
            cv::putText(display_frame, info, 
                       cv::Point(light.center.x + 5, light.center.y - 5),
                       cv::FONT_HERSHEY_SIMPLEX, 0.4, cv::Scalar(255, 255, 0), 1);
        }
        
        auto frame_end = std::chrono::high_resolution_clock::now();
        double frame_time = std::chrono::duration<double>(frame_end - frame_start).count() * 1000;
        total_process_time += frame_time;
        
        // åœ¨å›¾åƒä¸Šæ˜¾ç¤ºå¸§ä¿¡æ¯
        std::string fps_text = "å¸§: " + std::to_string(frame_count);
        cv::putText(display_frame, fps_text, cv::Point(10, 25), 
                   cv::FONT_HERSHEY_SIMPLEX, 0.7, cv::Scalar(0, 255, 255), 2);
        
        std::string lights_text = "ç¯æ¡: " + std::to_string(lights.size());
        cv::putText(display_frame, lights_text, cv::Point(10, 55), 
                   cv::FONT_HERSHEY_SIMPLEX, 0.7, cv::Scalar(0, 255, 255), 2);
        
        std::string time_text = "æ—¶é—´: " + std::to_string(int(frame_time)) + "ms";
        cv::putText(display_frame, time_text, cv::Point(10, 85), 
                   cv::FONT_HERSHEY_SIMPLEX, 0.7, cv::Scalar(0, 255, 255), 2);
        
        // æ˜¾ç¤ºå›¾åƒ
        cv::imshow("è£…ç”²æ¿æ£€æµ‹ç»“æœ", display_frame);
        cv::imshow("äºŒå€¼åŒ–å›¾åƒ", binary);
        
        // ç»ˆç«¯è¾“å‡ºï¼ˆæ¯10å¸§è¾“å‡ºä¸€æ¬¡ï¼‰
        if (frame_count % 10 == 0) {
            std::cout << "[å¸§ " << frame_count << "] "
                      << "ç¯æ¡: " << lights.size() << ", "
                      << "é¢„å¤„ç†: " << preprocess_time << "ms, "
                      << "æ£€æµ‹: " << find_time << "ms, "
                      << "æ€»è®¡: " << frame_time << "ms" << std::endl;
        }
        
        // é”®ç›˜æ§åˆ¶
        char key = cv::waitKey(1);
        if (key == 'q' || key == 27) {  // 'q' æˆ– ESC
            std::cout << "â¹ï¸  ç”¨æˆ·ä¸­æ–­" << std::endl;
            break;
        } else if (key == ' ') {  // ç©ºæ ¼æš‚åœ
            std::cout << "â¸ï¸  æš‚åœï¼ŒæŒ‰ä»»æ„é”®ç»§ç»­..." << std::endl;
            cv::waitKey(0);
        } else if (key == 's') {  // ä¿å­˜å½“å‰å¸§
            std::string filename = "frame_" + std::to_string(frame_count) + ".png";
            cv::imwrite(filename, display_frame);
            std::cout << "ğŸ’¾ ä¿å­˜å¸§åˆ°: " << filename << std::endl;
        }
    }
    
    // ç»Ÿè®¡ä¿¡æ¯
    std::cout << "\n==========================================" << std::endl;
    std::cout << "ğŸ“Š å¤„ç†ç»Ÿè®¡:" << std::endl;
    std::cout << "   æ€»å¸§æ•°: " << frame_count << std::endl;
    if (frame_count > 0) {
        double avg_time = total_process_time / frame_count;
        std::cout << "   å¹³å‡æ¯å¸§æ—¶é—´: " << avg_time << " ms" << std::endl;
        std::cout << "   ä¼°ç®—å¸§ç‡: " << 1000.0 / avg_time << " FPS" << std::endl;
    }
    std::cout << "==========================================" << std::endl;
    
    // æ¸…ç†
    cap.release();
    cv::destroyAllWindows();
    
    std::cout << "âœ… ç¨‹åºæ­£å¸¸ç»“æŸ" << std::endl;
    return 0;
}